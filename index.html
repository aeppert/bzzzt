<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>bzzzt</title>
  </head>
  <body>
    <button id="button" active>Unlock</button>
    <script>
    (function() {
      function post(query, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", document.location.pathname, true);
        xhr.setRequestHeader("content-type",
                             "application/x-www-form-urlencoded");
        xhr.send(query);

        xhr.onreadystatechange = function() {
          if (xhr.readyState == 4) {
            if (xhr.status == 200) {
              if (typeof callback === "function") {
                callback();
              }
            }
          }
        };

        return xhr;
      }

      var button = document.getElementById("button");

      button.addEventListener("mousedown", function(e) {
        if (e.button !== 0) {
          return;
        }

        var token = Date.now();
        var mouseDownCompleted = false;
        var mouseUp;

        function onMouseUp() {
          mouseUp = post.bind(null, "token=" + token + "&is_pressed=no");
          if (mouseDownCompleted) {
            mouseUp();
            mouseUp = null;
          }
          button.removeEventListener("mouseup", onMouseUp);
        }

        post("token=" + token + "&is_pressed=yes", function() {
          if (typeof mouseUp === "function") {
            mouseUp();
          }
          mouseDownCompleted = true;
        });

        button.addEventListener("mouseup", onMouseUp, false);
      }, false);
    })();
    </script>
  </body>
</html>
